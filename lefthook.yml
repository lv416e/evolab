pre-commit:
  parallel: true
  commands:
    format:
      run: |
        FILES=$(printf '%s\0' {staged_files} \
          | xargs -0 -I{} sh -c 'test -f "{}" && printf "%s\0" "{}"' \
          | grep -E -z '\.(c|cc|cpp|cxx|h|hpp)$' || true)
        if command -v git-clang-format >/dev/null 2>&1; then
          git clang-format --style=file --staged || true
        fi
        printf '%s' "$FILES" | xargs -0 -r clang-format -i --style=file
      stage_fixed: true
      fail_text: "clang-format has been applied. Please stage the changes and commit again."

    sanity:
      run: |
        if [ ! -f build/compile_commands.json ]; then
          echo "⚠️  No compile_commands.json. Hint: cmake -S . -B build -DCMAKE_EXPORT_COMPILE_COMMANDS=ON"
          exit 0
        fi
        CHANGED=$(printf '%s\0' {staged_files} \
          | xargs -0 -I{} sh -c 'test -f "{}" && printf "%s\n" "{}"' \
          | grep -E '\.(cc|cpp|cxx)$' || true)
        if [ -n "$CHANGED" ]; then
          echo "$CHANGED" | xargs -r -n 1 clang-tidy -p build --quiet || true
        fi
      fail_text: "clang-tidy has suggestions (non-blocking)."

pre-push:
  parallel: true
  commands:
    changed-check:
      run: |
        if ! git diff --name-only --cached | grep -Eq '^(src|include|apps|tests)/.*\.(c|cc|cpp|cxx|h|hpp)$'; then
          echo "No code changes. Skipping build & tests."
          exit 0
        fi

    cmake-configure:
      run: |
        if [ ! -d build ]; then
          cmake -S . -B build -G Ninja \
                -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
                -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        fi

    build:
      run: cmake --build build --parallel

    test:
      run: |
        CORES=$(getconf _NPROCESSORS_ONLN 2>/dev/null || sysctl -n hw.ncpu)
        ctest --test-dir build --output-on-failure --stop-on-failure -j "${CORES:-4}" --timeout 120 -L smoke
